!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):$.sammy=window.Sammy=t($)}(function(t){var e,n="([^/]+)",i=/:([\w\d]+)/g,r=/\?([^#]*)?$/,o=function(t){return Array.prototype.slice.call(t)},a=function(t){return"[object Function]"===Object.prototype.toString.call(t)},s=function(t){return"[object Array]"===Object.prototype.toString.call(t)},u=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},c=function(t){return decodeURIComponent((t||"").replace(/\+/g," "))},h=encodeURIComponent,p=function(t){return String(t).replace(/&(?!\w+;)/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},l=function(t){return function(){return this.route.apply(this,[t].concat(Array.prototype.slice.call(arguments)))}},f={},g=!(!window.history||!history.pushState),d=[];return e=function(){var n,i,r=o(arguments);return e.apps=e.apps||{},0===r.length||r[0]&&a(r[0])?e.apply(e,["body"].concat(r)):"string"==typeof(i=r.shift())?(n=e.apps[i]||new e.Application,n.element_selector=i,r.length>0&&t.each(r,function(t,e){n.use(e)}),n.element_selector!=i&&delete e.apps[i],e.apps[n.element_selector]=n,n):void 0},e.VERSION="0.7.4",e.addLogger=function(t){d.push(t)},e.log=function(){var n=o(arguments);n.unshift("["+Date()+"]"),t.each(d,function(t,i){i.apply(e,n)})},"undefined"!=typeof window.console?e.addLogger(a(window.console.log.apply)?function(){window.console.log.apply(window.console,arguments)}:function(){window.console.log(arguments)}):"undefined"!=typeof console&&e.addLogger(function(){console.log.apply(console,arguments)}),t.extend(e,{makeArray:o,isFunction:a,isArray:s}),e.Object=function(e){return t.extend(this,e||{})},t.extend(e.Object.prototype,{escapeHTML:p,h:p,toHash:function(){var e={};return t.each(this,function(t,n){a(n)||(e[t]=n)}),e},toHTML:function(){var e="";return t.each(this,function(t,n){a(n)||(e+="<strong>"+t+"</strong> "+n+"<br />")}),e},keys:function(t){var e=[];for(var n in this)a(this[n])&&t||e.push(n);return e},has:function(e){return this[e]&&""!==t.trim(this[e].toString())},join:function(){var t=o(arguments),e=t.shift();return t.join(e)},log:function(){e.log.apply(e,arguments)},toString:function(e){var n=[];return t.each(this,function(t,i){(!a(i)||e)&&n.push('"'+t+'": '+i.toString())}),"Sammy.Object: {"+n.join(",")+"}"}}),e.targetIsThisWindow=function(e){var n=t(e.target).attr("target");return n&&n!==window.name&&"_self"!==n?"_blank"===n?!1:"top"===n&&window===window.top?!0:!1:!0},e.DefaultLocationProxy=function(t,e){this.app=t,this.is_native=!1,this.has_history=g,this._startPolling(e)},e.DefaultLocationProxy.fullPath=function(t){var e=t.toString().match(/^[^#]*(#.+)$/),n=e?e[1]:"";return[t.pathname,t.search,n].join("")},t.extend(e.DefaultLocationProxy.prototype,{bind:function(){var n=this,i=this.app,r=e.DefaultLocationProxy;t(window).bind("hashchange."+this.app.eventNamespace(),function(t,e){n.is_native!==!1||e||(n.is_native=!0,window.clearInterval(r._interval),r._interval=null),i.trigger("location-changed")}),g&&!i.disable_push_state&&(t(window).bind("popstate."+this.app.eventNamespace(),function(){i.trigger("location-changed")}),t(document).delegate("a","click.history-"+this.app.eventNamespace(),function(t){if(!(t.isDefaultPrevented()||t.metaKey||t.ctrlKey)){var o=r.fullPath(this),a=this.hostname?this.hostname:function(t){var e=document.createElement("a");return e.href=t.href,e.hostname}(this);return a==window.location.hostname&&i.lookupRoute("get",o)&&e.targetIsThisWindow(t)?(t.preventDefault(),n.setLocation(o),!1):void 0}})),r._bindings||(r._bindings=0),r._bindings++},unbind:function(){t(window).unbind("hashchange."+this.app.eventNamespace()),t(window).unbind("popstate."+this.app.eventNamespace()),t(document).undelegate("a","click.history-"+this.app.eventNamespace()),e.DefaultLocationProxy._bindings--,e.DefaultLocationProxy._bindings<=0&&(window.clearInterval(e.DefaultLocationProxy._interval),e.DefaultLocationProxy._interval=null)},getLocation:function(){return e.DefaultLocationProxy.fullPath(window.location)},setLocation:function(t){if(/^([^#\/]|$)/.test(t)&&(t=g&&!this.app.disable_push_state?"/"+t:"#!/"+t),t!=this.getLocation()){if(!g||this.app.disable_push_state||!/^\//.test(t))return window.location=t;history.pushState({path:t},window.title,t),this.app.trigger("location-changed")}},_startPolling:function(n){var i=this;if(!e.DefaultLocationProxy._interval){n||(n=10);var r=function(){var n=i.getLocation();("undefined"==typeof e.DefaultLocationProxy._last_location||n!=e.DefaultLocationProxy._last_location)&&window.setTimeout(function(){t(window).trigger("hashchange",[!0])},0),e.DefaultLocationProxy._last_location=n};r(),e.DefaultLocationProxy._interval=window.setInterval(r,n)}}}),e.Application=function(t){var n=this;this.routes={},this.listeners=new e.Object({}),this.arounds=[],this.befores=[],this.namespace=(new Date).getTime()+"-"+parseInt(1e3*Math.random(),10),this.context_prototype=function(){e.EventContext.apply(this,arguments)},this.context_prototype.prototype=new e.EventContext,a(t)&&t.apply(this,[this]),this._location_proxy||this.setLocationProxy(new e.DefaultLocationProxy(this,this.run_interval_every)),this.debug&&this.bindToAllEvents(function(t,e){n.log(n.toString(),t.cleaned_type,e||{})})},e.Application.prototype=t.extend({},e.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,disable_push_state:!1,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(e){return e?t(this.element_selector).find(e):t(this.element_selector)},use:function(){var t=o(arguments),n=t.shift(),i=n||"";try{t.unshift(this),"string"==typeof n&&(i="Sammy."+n,n=e[n]),n.apply(this,t)}catch(r){"undefined"==typeof n?this.error("Plugin Error: called use() but plugin ("+i.toString()+") is not defined",r):a(n)?this.error("Plugin Error",r):this.error("Plugin Error: called use() but '"+i.toString()+"' is not a function",r)}return this},setLocationProxy:function(t){var e=this._location_proxy;this._location_proxy=t,this.isRunning()&&(e&&e.unbind(),this._location_proxy.bind())},log:function(){e.log.apply(e,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(e,r){var o,s,u=this,c=[],h=Array.prototype.slice.call(arguments,2);if(0===h.length&&a(r)&&(r=e,h=[r],e="any"),e=e.toLowerCase(),r.constructor==String){for(i.lastIndex=0;null!==(s=i.exec(r));)c.push(s[1]);r=new RegExp(r.replace(i,n)+"$")}return t.each(h,function(t,e){"string"==typeof e&&(h[t]=u[e])}),o=function(t){var e={verb:t,path:r,callback:h,param_names:c};u.routes[t]=u.routes[t]||[],u.routes[t].push(e)},"any"===e?t.each(this.ROUTE_VERBS,function(t,e){o(e)}):o(e),this},get:l("get"),post:l("post"),put:l("put"),del:l("delete"),any:l("any"),mapRoutes:function(e){var n=this;return t.each(e,function(t,e){n.route.apply(n,e)}),this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(t,e,n){var i=this;"undefined"==typeof n&&(n=e);var r=function(){var t,e,r;t=arguments[0],r=arguments[1],r&&r.context?(e=r.context,delete r.context):e=new i.context_prototype(i,"bind",t.type,r,t.target),t.cleaned_type=t.type.replace(i.eventNamespace(),""),n.apply(e,[t,r])};return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(r),this.isRunning()&&this._listen(t,r),this},trigger:function(t,e){return this.$element().trigger([t,this.eventNamespace()].join("."),[e]),this},refresh:function(){return this.last_location=null,this.trigger("location-changed"),this},before:function(t,e){return a(t)&&(e=t,t={}),this.befores.push([t,e]),this},after:function(t){return this.bind("event-context-after",t)},around:function(t){return this.arounds.push(t),this},onComplete:function(t){return this._onComplete=t,this},isRunning:function(){return this._running},helpers:function(e){return t.extend(this.context_prototype.prototype,e),this},helper:function(t,e){return this.context_prototype.prototype[t]=e,this},run:function(n){if(this.isRunning())return!1;var i=this;return t.each(this.listeners.toHash(),function(e,n){t.each(n,function(t,n){i._listen(e,n)})}),this.trigger("run",{start_url:n}),this._running=!0,this.last_location=null,/\#(.+)/.test(this.getLocation())||"undefined"==typeof n||this.setLocation(n),this._checkLocation(),this._location_proxy.bind(),this.bind("location-changed",function(){i._checkLocation()}),this.bind("submit",function(n){if(!e.targetIsThisWindow(n))return!0;var r=i._checkFormSubmission(t(n.target).closest("form"));return r===!1?n.preventDefault():!1}),t(window).bind("unload",function(){i.unload()}),this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var e=this;return this.trigger("unload"),this._location_proxy.unbind(),this.$element().unbind("submit").removeClass(e.eventNamespace()),t.each(this.listeners.toHash(),function(n,i){t.each(i,function(t,i){e._unlisten(n,i)})}),this._running=!1,this},destroy:function(){return this.unload(),delete e.apps[this.element_selector],this},bindToAllEvents:function(e){var n=this;return t.each(this.APP_EVENTS,function(t,i){n.bind(i,e)}),t.each(this.listeners.keys(!0),function(i,r){-1==t.inArray(r,n.APP_EVENTS)&&n.bind(r,e)}),this},routablePath:function(t){return t.replace(r,"")},lookupRoute:function(t,e){var n,i,r=this,o=!1,a=0;if("undefined"!=typeof this.routes[t])for(n=this.routes[t].length;n>a;a++)if(i=this.routes[t][a],r.routablePath(e).match(i.path)){o=i;break}return o},runRoute:function(e,n,i,r){var o,a,s,u,h,p,l,f,g=this,d=this.lookupRoute(e,n);if(this.debug&&this.log("runRoute",[e,n].join(" ")),this.trigger("run-route",{verb:e,path:n,params:i}),"undefined"==typeof i&&(i={}),t.extend(i,this._parseQueryString(n)),d){this.trigger("route-found",{route:d}),null!==(l=d.path.exec(this.routablePath(n)))&&(l.shift(),t.each(l,function(t,e){d.param_names[t]?i[d.param_names[t]]=c(e):(i.splat||(i.splat=[]),i.splat.push(c(e)))})),o=new this.context_prototype(this,e,n,i,r),s=this.arounds.slice(0),u=this.befores.slice(0),p=[o],i.splat&&(p=p.concat(i.splat)),a=function(){for(var t,e,n;u.length>0;)if(h=u.shift(),g.contextMatchesOptions(o,h[0])&&(t=h[1].apply(o,[o]),t===!1))return!1;return g.last_route=d,o.trigger("event-context-before",{context:o}),"function"==typeof d.callback&&(d.callback=[d.callback]),d.callback&&d.callback.length&&(e=-1,n=function(){e++,d.callback[e]?t=d.callback[e].apply(o,p):g._onComplete&&g._onComplete(o)},p.push(n),n()),o.trigger("event-context-after",{context:o}),t},t.each(s.reverse(),function(t,e){var n=a;a=function(){return e.apply(o,[n])}});try{f=a()}catch(m){this.error(["500 Error",e,n].join(" "),m)}return f}return this.notFound(e,n)},contextMatchesOptions:function(e,n,i){var r=n;if(("string"==typeof r||u(r))&&(r={path:r}),"undefined"==typeof i&&(i=!0),t.isEmptyObject(r))return!0;if(s(r.path)){var o,a,c,h;for(o=[],a=0,h=r.path.length;h>a;a+=1)c=t.extend({},r,{path:r.path[a]}),o.push(this.contextMatchesOptions(e,c));var p=t.inArray(!0,o)>-1?!0:!1;return i?p:!p}if(r.only)return this.contextMatchesOptions(e,r.only,!0);if(r.except)return this.contextMatchesOptions(e,r.except,!1);var l=!0,f=!0;return r.path&&(u(r.path)||(r.path=new RegExp(r.path.toString()+"$")),l=r.path.test(e.path)),r.verb&&(f="string"==typeof r.verb?r.verb===e.verb:r.verb.indexOf(e.verb)>-1),i?f&&l:!(f&&l)},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(t){return this._location_proxy.setLocation(t)},swap:function(t,e){var n=this.$element().html(t);return a(e)&&e(t),n},templateCache:function(t,e){return"undefined"!=typeof e?f[t]=e:f[t]},clearTemplateCache:function(){return f={}},notFound:function(t,e){var n=this.error(["404 Not Found",t,e].join(" "));return"get"===t?n:!0},error:function(t,e){if(e||(e=new Error),e.message=[t,e.message].join(" "),this.trigger("error",{message:e.message,error:e}),this.raise_errors)throw e;this.log(e.message,e)},_checkLocation:function(){var t,e;return t=this.getLocation(),this.last_location&&"get"==this.last_location[0]&&this.last_location[1]==t||(this.last_location=["get",t],e=this.runRoute("get",t)),e},_getFormVerb:function(e){var n,i,r=t(e);return i=r.find('input[name="_method"]'),i.length>0&&(n=i.val()),n||(n=r[0].getAttribute("method")),n&&""!==n||(n="get"),t.trim(n.toString().toLowerCase())},_checkFormSubmission:function(e){var n,i,r,o,a;return this.trigger("check-form-submission",{form:e}),n=t(e),i=n.attr("action")||"",r=this._getFormVerb(n),this.debug&&this.log("_checkFormSubmission",n,i,r),"get"===r?(o=this._serializeFormParams(n),""!==o&&(i+="?"+o),this.setLocation(i),a=!1):(o=t.extend({},this._parseFormParams(n)),a=this.runRoute(r,i,o,e.get(0))),"undefined"==typeof a?!1:a},_serializeFormParams:function(t){var e,n="",i=t.serializeArray();if(i.length>0)for(n=this._encodeFormPair(i[0].name,i[0].value),e=1;e<i.length;e++)n=n+"&"+this._encodeFormPair(i[e].name,i[e].value);return n},_encodeFormPair:function(t,e){return h(t)+"="+h(e)},_parseFormParams:function(t){var e,n={},i=t.serializeArray();for(e=0;e<i.length;e++)n=this._parseParamPair(n,i[e].name,i[e].value);return n},_parseQueryString:function(t){var e,n,i,o,a={};if(e=t.match(r),e&&e[1])for(n=e[1].split("&"),o=0;o<n.length;o++)i=n[o].split("="),a=this._parseParamPair(a,c(i[0]),c(i[1]||""));return a},_parseParamPair:function(t,e,n){return"undefined"!=typeof t[e]?s(t[e])?t[e].push(n):t[e]=[t[e],n]:t[e]=n,t},_listen:function(t,e){return this.$element().bind([t,this.eventNamespace()].join("."),e)},_unlisten:function(t,e){return this.$element().unbind([t,this.eventNamespace()].join("."),e)}}),e.RenderContext=function(t){this.event_context=t,this.callbacks=[],this.previous_content=null,this.content=null,this.next_engine=!1,this.waiting=!1},e.RenderContext.prototype=t.extend({},e.Object.prototype,{then:function(t){if(!a(t)){if(!("string"==typeof t&&t in this.event_context))return this;var e=this.event_context[t];t=function(t){return e.apply(this.event_context,[t])}}var n=this;return this.waiting?this.callbacks.push(t):(this.wait(),window.setTimeout(function(){var e=t.apply(n,[n.content,n.previous_content]);e!==!1&&n.next(e)},0)),this},wait:function(){this.waiting=!0},next:function(t){this.waiting=!1,"undefined"!=typeof t&&(this.previous_content=this.content,this.content=t),this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(e,n,i){var r=this;return this.then(function(){var o,s,u;return a(n)?(i=n,n={}):n=t.extend({},n),i&&this.then(i),"string"==typeof e?(u=e.match(/\.json$/)||n.json,o=u?n.cache===!0:n.cache!==!1,r.next_engine=r.event_context.engineFor(e),delete n.cache,delete n.json,n.engine&&(r.next_engine=n.engine,delete n.engine),o&&(s=this.event_context.app.templateCache(e))?s:(this.wait(),t.ajax(t.extend({url:e,data:{},dataType:u?"json":"text",type:"get",success:function(t){o&&r.event_context.app.templateCache(e,t),r.next(t)}},n)),!1)):e.nodeType?e.innerHTML:e.selector?(r.next_engine=e.attr("data-engine"),n.clone===!1?e.remove()[0].innerHTML.toString():e[0].innerHTML.toString()):void 0})},loadPartials:function(t){var e;if(t){this.partials=this.partials||{};for(e in t)!function(e,n){e.load(t[n]).then(function(t){this.partials[n]=t})}(this,e)}return this},render:function(t,e,n,i){return a(t)&&!e?this.then(t):(a(e)?(i=n,n=e,e=null):n&&!a(n)&&(i=n,n=null),this.loadPartials(i).load(t).interpolate(e,t).then(n))},partial:function(t,e,n,i){return a(n)?this.render(t,e,i).swap(n):a(e)?this.render(t,{},n).swap(e):this.render(t,e,n).swap()},send:function(){var t=this,e=o(arguments),n=e.shift();return s(e[0])&&(e=e[0]),this.then(function(){return e.push(function(e){t.next(e)}),t.wait(),n.apply(n,e),!1})},collect:function(e,n,i){var r=this,o=function(){a(e)&&(n=e,e=this.content);var i=[],o=!1;return t.each(e,function(t,e){var a=n.apply(r,[t,e]);return a.jquery&&1==a.length&&(a=a[0],o=!0),i.push(a),a}),o?i:i.join("")};return i?o():this.then(o)},renderEach:function(e,n,i,r){return s(n)&&(r=i,i=n,n=null),this.load(e).then(function(o){var a=this;return i||(i=s(this.previous_content)?this.previous_content:[]),r?void t.each(i,function(t,i){var s={},u=this.next_engine||e;n?s[n]=i:s=i,r(i,a.event_context.interpolate(o,s,u))}):this.collect(i,function(t,i){var r={},a=this.next_engine||e;return n?r[n]=i:r=i,this.event_context.interpolate(o,r,a)},!0)})},interpolate:function(t,e,n){var i=this;return this.then(function(r,o){!t&&o&&(t=o),this.next_engine&&(e=this.next_engine,this.next_engine=!1);var a=i.event_context.interpolate(r,t,e,this.partials);return n?o+a:a})},swap:function(t){return this.then(function(e){return this.event_context.swap(e,t),e}).trigger("changed",{})},appendTo:function(e){return this.then(function(n){t(e).append(n)}).trigger("changed",{})},prependTo:function(e){return this.then(function(n){t(e).prepend(n)}).trigger("changed",{})},replace:function(e){return this.then(function(n){t(e).html(n)}).trigger("changed",{})},trigger:function(t,e){return this.then(function(n){return"undefined"==typeof e&&(e={content:n}),this.event_context.trigger(t,e),n})}}),e.EventContext=function(t,n,i,r,o){this.app=t,this.verb=n,this.path=i,this.params=new e.Object(r),this.target=o},e.EventContext.prototype=t.extend({},e.Object.prototype,{$element:function(){return this.app.$element(o(arguments).shift())},engineFor:function(t){var e,n=this;return a(t)?t:(t=(t||n.app.template_engine).toString(),(e=t.match(/\.([^\.\?\#]+)$/))&&(t=e[1]),t&&a(n[t])?n[t]:n.app.template_engine?this.engineFor(n.app.template_engine):function(t){return t})},interpolate:function(t,e,n,i){return this.engineFor(n).apply(this,[t,e,i])},render:function(t,n,i,r){return new e.RenderContext(this).render(t,n,i,r)},renderEach:function(t,n,i,r){return new e.RenderContext(this).renderEach(t,n,i,r)},load:function(t,n,i){return new e.RenderContext(this).load(t,n,i)},loadPartials:function(t){return new e.RenderContext(this).loadPartials(t)},partial:function(t,n,i,r){return new e.RenderContext(this).partial(t,n,i,r)},send:function(){var t=new e.RenderContext(this);return t.send.apply(t,arguments)},redirect:function(){var e,n=o(arguments),i=this.app.getLocation(),r=n.length;if(r>1){for(var a=0,s=[],u=[],c={},h=!1;r>a;a++)"string"==typeof n[a]?s.push(n[a]):(t.extend(c,n[a]),h=!0);if(e=s.join("/"),h){for(var p in c)u.push(this.app._encodeFormPair(p,c[p]));e+="?"+u.join("&")}}else e=n[0];this.trigger("redirect",{to:e}),this.app.last_location=[this.verb,this.path],this.app.setLocation(e),new RegExp(e).test(i)&&this.app.trigger("location-changed")},trigger:function(t,e){return"undefined"==typeof e&&(e={}),e.context||(e.context=this),this.app.trigger(t,e)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(t,e){return this.app.swap(t,e)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(e){return t.parseJSON(e)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}}),e});